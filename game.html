<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Production Tycoon</title>
    
    <!-- Single consolidated stylesheet -->
    <link rel="stylesheet" href="styles/game.css">
</head>
<body>
    <!-- Main game container -->
    <div id="game-root">
        <!-- Game header -->
        <div class="game-header">
            <h1>City Production Tycoon</h1>
            <div class="header-controls">
                <button class="btn btn-secondary btn-small" onclick="Game.clearOldSave()" title="Clear save data and restart with factory system">
                    üîÑ Reset Game
                </button>
            </div>
        </div>
        
        <!-- Two-panel layout: Production + Research/Stats -->
        <div class="game-container">
            <!-- Left Panel: Production (Resources + Buildings Unified) -->
            <div class="panel panel-left panel-wide">
                <div class="card">
                    <div class="card-title">Production Overview</div>
                    <div class="card-content">
                        <div class="overflow-x-auto">
                            <table id="game-table" class="resource-empire-table">
                                <thead>
                                    <tr class="section-headers">
                                        <th class="resource-section-header" colspan="4">
                                            <div class="section-title">
                                                üìä Resources
                                            </div>
                                        </th>
                                        <th class="building-section-header" colspan="5">
                                            <div class="section-title">
                                                üèóÔ∏è Buildings
                                            </div>
                                        </th>
                                        <th class="upgrade-section-header" colspan="5">
                                            <div class="section-title">
                                                ‚¨ÜÔ∏è Upgrades
                                            </div>
                                        </th>
                                    </tr>
                                    <tr class="column-headers">
                                        <!-- Resource Headers -->
                                        <th class="resource-header">Resource</th>
                                        <th class="resource-header">Amount</th>
                                        <th class="resource-header">Income</th>
                                        <th class="resource-header">Expense</th>
                                        <!-- Building Headers -->
                                        <th class="building-header">Building</th>
                                        <th class="building-header">Benefit</th>
                                        <th class="building-header">Owned</th>
                                        <th class="building-header">Cost</th>
                                        <th class="building-header">Action</th>
                                        <!-- Upgrade Headers -->
                                        <th class="upgrade-header">Upgrade</th>
                                        <th class="upgrade-header">Benefit</th>
                                        <th class="upgrade-header">Status</th>
                                        <th class="upgrade-header">Cost</th>
                                        <th class="upgrade-header">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="game-table-body">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div id="unlock-hint" class="mt-md hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Research, Statistics & Upgrades -->
            <div class="panel panel-right">
                <!-- Research Panel -->
                <div class="card">
                    <div class="card-title">Research Lab</div>
                    <div class="card-content">
                        <div id="research-panel"></div>
                    </div>
                </div>
                
                <!-- Statistics Panel -->
                <div class="card">
                    <div class="card-title">Statistics</div>
                    <div class="card-content">
                        <div id="stats-panel"></div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- LOAD SCRIPTS IN DEPENDENCY ORDER              -->
    <!-- ============================================= -->
    
    <!-- 1. Constants and Configuration -->
    <script src="src/data/constants.js"></script>
    <script src="src/data/buildings.js"></script>
    <script src="src/data/upgrades.js"></script>
    
    <!-- 2. Utility Functions -->
    <script src="src/utils/formatters.js"></script>
    <script src="src/utils/helpers.js"></script>
    
    <!-- 3. Core Game Systems -->
    <script src="src/core/gameState.js"></script>
    <script src="src/systems/resourceSystem.js"></script>
    <script src="src/systems/buildingSystem.js"></script>
    <script src="src/systems/upgradeSystem.js"></script>
    <script src="src/systems/researchSystem.js"></script>
    
    <!-- 4. UI Components -->
    <script src="src/ui/SimpleTableUI.js"></script>
    
    <!-- 5. Main Game Controller -->
    <script src="src/core/game.js"></script>
    
    <!-- 6. Game initialization -->
    <script>
        // =============================================================
        // GAME STARTUP
        // =============================================================
        
        /**
         * Main game initialization function
         * Called when the page is fully loaded
         */
        function startGame() {
            console.log('üéÆ Starting City Production Tycoon...');
            console.log('üìÅ Using fully modular architecture');
            
            try {
                // Add fallbacks for missing systems
                addSystemFallbacks();
                
                // Initialize the game through the main controller
                Game.initialize();
                
                console.log('‚úÖ Game started successfully!');
            } catch (error) {
                console.error('‚ùå Game initialization failed:', error);
                
                // Show error to user
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; max-width: 400px; z-index: 9999;';
                errorDiv.innerHTML = `
                    <h4>Game Initialization Failed</h4>
                    <p>${error.message}</p>
                    <button onclick="this.parentElement.remove()">Close</button>
                `;
                document.body.appendChild(errorDiv);
            }
        }
        
        /**
         * Add fallbacks for missing systems to prevent crashes
         */
        function addSystemFallbacks() {
            // Notification system fallback
            if (typeof NotificationSystem === 'undefined') {
                console.warn('NotificationSystem not found, adding fallback');
                window.NotificationSystem = {
                    show: (message, type, duration) => {
                        console.log(`[${type?.toUpperCase() || 'INFO'}] ${message}`);
                        
                        // Simple toast notification
                        const toast = document.createElement('div');
                        toast.style.cssText = `
                            position: fixed; top: 20px; right: 20px; z-index: 9999;
                            padding: 10px 15px; border-radius: 5px; color: white;
                            background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
                        `;
                        toast.textContent = message;
                        document.body.appendChild(toast);
                        
                        setTimeout(() => toast.remove(), duration || 3000);
                    }
                };
            }
            
        }
        
        /**
         * Reset game function for debugging/testing
         */
        function debugResetGame() {
            Game.reset();
        }
        
        // Start the game when the page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startGame);
        } else {
            startGame();
        }
        
        // Make reset function available globally for debugging
        window.resetGame = debugResetGame;
        window.clearOldSave = Game.clearOldSave;
        
        // Load debug helpers in development mode
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.hostname === '') {
            const debugScript = document.createElement('script');
            debugScript.src = 'test/debug_helpers.js';
            debugScript.onerror = () => console.log('Debug helpers not loaded (production mode)');
            document.head.appendChild(debugScript);
        }
    </script>
</body>
</html>